<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>午夜突袭 — 本地演示（大厅 & 市场 & 仓库）</title>
<style>
  :root{
    --bg-1:#02030a; --bg-2:#071028; --neon1:#48f0ff; --neon2:#8a5bff;
    --muted: rgba(200,220,255,0.6); --radius:12px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eaf6ff;overflow:hidden}
  .bg-wrap{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .beam{ position:absolute; left:-20%; top:-30%; width:140%; height:160%; background: radial-gradient(ellipse at center, rgba(72,240,255,0.06), transparent 30%), linear-gradient(90deg, rgba(138,91,255,0.06), transparent 40%); transform: rotate(-8deg); filter: blur(28px) saturate(140%); animation: float 16s linear infinite; mix-blend-mode: screen; }
  .beam.b2{ transform: rotate(6deg) translateY(10%); animation-duration:24s; background: radial-gradient(ellipse at center, rgba(138,91,255,0.05), transparent 30%); }
  @keyframes float{ 0%{transform:translateY(-6%) rotate(-8deg);} 50%{transform:translateY(6%) rotate(-12deg);} 100%{transform:translateY(-6%) rotate(-8deg);} }
  .grain{ position:fixed; inset:0; z-index:0; opacity:0.06; background-image: radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px); background-size:4px 4px; pointer-events:none; }

  .wrap{position:relative;z-index:5;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box}
  .card{ width:min(920px,94vw); border-radius:var(--radius); padding:28px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); box-shadow: 0 8px 40px rgba(6,10,20,0.7); border: 1px solid rgba(138,91,255,0.08); display:flex; flex-direction:column; gap:14px; align-items:center; text-align:center; backdrop-filter: blur(6px) saturate(120%); }
  .title{ font-weight:900; font-size: clamp(28px,6.5vw,64px); margin:0; letter-spacing:0.6px; color:var(--neon1); text-shadow: 0 0 8px rgba(72,240,255,0.6); display:inline-block; padding:6px 14px; border-radius:10px; }
  .subtitle{ color:var(--muted); font-size:15px; margin:0; max-width:70ch; line-height:1.6; }
  .cta-row{ display:flex; gap:12px; margin-top:4px; }
  .btn{ --padx:14px; --pady:10px; padding:var(--pady) var(--padx); border-radius:10px; cursor:pointer; font-weight:800; font-size:14px; color: #05111a; border:none; background-image: linear-gradient(90deg, var(--neon1), var(--neon2)); }
  .btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); box-shadow:none; font-weight:700; }
  .meta{ font-size:13px; color: rgba(200,220,255,0.35); margin-top:6px; }

  .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background: linear-gradient(180deg, rgba(2,6,15,0.55), rgba(2,6,15,0.66)); }
  .modalCard{ width:min(900px,94vw); border-radius:12px; padding:16px; display:flex; gap:12px; background: linear-gradient(180deg, rgba(6,8,20,0.9), rgba(10,14,30,0.88)); border: 1px solid rgba(72,240,255,0.06); box-shadow: 0 18px 60px rgba(2,6,15,0.7); }
  .col{ flex:1; min-width:240px; padding:12px; display:flex; flex-direction:column; gap:10px; }
  label{ font-size:13px; color:var(--muted) }
  input[type="text"], input[type="password"]{ padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:#eaf6ff; outline:none; }
  .note{ padding:10px; border-radius:8px; background: linear-gradient(180deg, rgba(138,91,255,0.03), rgba(72,240,255,0.02)); color:var(--muted); font-size:13px; }

  .lobby{ position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .title-main{ font-weight:900; font-size: clamp(34px,6vw,96px); color:var(--neon1); margin-bottom:12px; }
  .lobby-panel{ position:relative; z-index:55; width:min(1200px,96vw); padding:28px; border-radius:14px; background: linear-gradient(180deg, rgba(2,6,20,0.6), rgba(2,6,20,0.45)); border:1px solid rgba(72,240,255,0.08); display:flex; gap:18px; align-items:flex-start; box-shadow: 0 20px 80px rgba(2,6,15,0.6); }
  .lobby-left{ width:260px; display:flex; flex-direction:column; gap:14px; align-items:center; }
  .avatar{ width:180px; height:180px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.03)); display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--neon1); border:1px solid rgba(72,240,255,0.06); font-size:44px; }
  .username{ font-weight:900; color:var(--neon1); font-size:20px; margin-top:6px; }
  .lobby-actions{ display:flex; flex-direction:column; gap:10px; width:100%; }
  .lobby-actions .btn{ width:100%; padding:14px 18px; font-size:16px; border-radius:12px; }
  .lobby-actions .btn.ghost{ padding:12px 16px; }
  .lobby-right{ flex:1; display:flex; flex-direction:column; gap:12px; }
  .panel-row{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
  .list{ padding:14px; border-radius:10px; background: rgba(255,255,255,0.02); min-height:140px; font-size:15px; color:var(--muted); }

  #stashFull{ display:none; position:fixed; inset:0; z-index:90; background:linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.97)); padding:24px; box-sizing:border-box; }
  #marketFull{ display:none; position:fixed; inset:0; z-index:92; background:linear-gradient(180deg, rgba(0,0,0,0.96), rgba(0,0,0,0.99)); padding:24px; box-sizing:border-box; }

  .market-card{ border-radius:10px; padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; gap:8px; align-items:center; }
  .market-visual{ width:200px; height:200px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:20px; color:#071018; margin:0 auto; position:relative; overflow:hidden; }
  .market-visual img.market-img{ max-width:90%; max-height:90%; object-fit:contain; display:block; pointer-events:none; }

  .market-meta{ display:flex; justify-content:space-between; align-items:center; font-weight:800; width:100%; padding:0 8px; box-sizing:border-box; }
  .market-actions{ display:flex; justify-content:flex-end; gap:8px; width:100%; padding:0 8px; box-sizing:border-box; }

  /* 让市场内容成为明确的垂直滚动区域 */
  #marketContent {
    flex: 1 1 auto;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    max-height: calc(100vh - 200px);
  }

  .dragging { cursor: grabbing; user-select: none; }

  @media (max-width:860px){
    .market-visual{ width:160px; height:160px; }
    #marketContent { max-height: calc(100vh - 180px); }
  }

  button:focus, input:focus { outline-offset:3px; outline:2px solid rgba(138,91,255,0.14); }

  /* toast 简单样式（动态创建） */
  .toast { transition: opacity .6s; }
</style>
</head>
<body>

 <div class="bg-wrap" aria-hidden="true"><div class="beam"></div><div class="beam b2"></div><div class="grain"></div></div>

 <!-- 初始提示页 -->
 <div class="wrap" role="main">
   <div class="card" role="article" aria-labelledby="title">
     <h1 id="title" class="title">午夜突袭</h1>
     <p class="subtitle">本地演示 — 登录后进入大本营（仓库 / 市场）</p>
     <div class="cta-row" role="group" aria-label="actions">
       <button id="agreeBtn" class="btn">我已阅读并进入</button>
       <button id="readMore" class="btn ghost" aria-controls="termsDetail">查看详细条款</button>
     </div>
     <div class="meta">© 午夜突袭 — 本地演示版</div>
   </div>
 </div>

 <!-- 条款 -->
 <div id="termsDetail" style="display:none; position:fixed; right:18px; top:18px; z-index:70; background:rgba(4,8,18,0.95); color:var(--muted); padding:12px 14px; border-radius:10px; width:min(420px,86vw); border:1px solid rgba(72,240,255,0.04);">
   <strong style="color:var(--neon1)">使用注意</strong>
   <p style="margin:8px 0 0 0; line-height:1.5; font-size:13px;">
     本游戏为本地演示，账号数据保存在浏览器 localStorage。若清除浏览器数据将丢失。<br><br>
     本游戏可能包含强光或快速闪烁，请注意休息。
   </p>
 </div>

 <!-- 账号 Modal（登录 / 注册 / 导出导入） -->
 <div id="accountModal" class="modal" style="display:none" role="dialog" aria-modal="true" aria-label="本地账号管理">
   <div class="modalCard" role="document">
     <div class="col" aria-labelledby="loginTitle">
       <h3 id="loginTitle">登录</h3>
       <label for="loginUser">用户名</label>
       <input id="loginUser" type="text" autocomplete="username" placeholder="你的用户名">
       <label for="loginPass">密码</label>
       <input id="loginPass" type="password" autocomplete="current-password" placeholder="你的密码">
       <div class="row" style="margin-top:6px;">
         <button id="loginBtn" class="btn">登录</button>
         <button id="guestBtn" class="btn ghost">游客进入</button>
       </div>
       <p class="note" style="margin-top:8px">若忘记密码且没有导出备份，则无法恢复（数据仅保存在本地）。</p>
     </div>

     <div class="col" aria-labelledby="regTitle">
       <h3 id="regTitle">创建本地账号</h3>
       <label for="regUser">用户名（3-20）</label>
       <input id="regUser" type="text" autocomplete="username" placeholder="例如：player01">
       <label for="regPass">密码（≥6）</label>
       <input id="regPass" type="password" autocomplete="new-password" placeholder="一个本地密码">
       <label for="regPass2">确认密码</label>
       <input id="regPass2" type="password" placeholder="再次输入密码">
       <div class="row" style="margin-top:6px;">
         <button id="regBtn" class="btn">创建账号（仅本地）</button>
         <button id="exportBtn" class="btn ghost">导出备份</button>
       </div>
       <div class="note" style="margin-top:8px">
         <strong>重要：</strong> 账号仅保存在此设备（localStorage）。建议导出备份以便恢复。
       </div>
       <div style="margin-top:8px;">
         <input id="importFile" type="file" accept="application/json" style="display:none">
         <button id="importBtn" class="btn ghost">导入备份</button>
       </div>
     </div>
   </div>
 </div>

 <!-- 大厅 -->
 <div id="lobby" class="lobby" role="application" aria-hidden="true">
   <div style="text-align:center; width:100%; margin-bottom:8px;">
     <div class="title-main">午夜突袭</div>
     <div style="color:var(--muted); font-size:14px;">小型单机搜打撤模拟 — 本地演示</div>
   </div>

   <div class="lobby-panel" role="region" aria-label="游戏大厅">
     <div class="lobby-left">
       <div class="avatar" id="lobbyAvatar">HZ</div>
       <div class="username" id="lobbyName">player</div>
       <div id="goldDisplay" style="margin-top:6px; font-weight:800; color:var(--neon2);">银币: 0K</div>

       <div class="lobby-actions">
         <button id="playBtn" class="btn">开始突袭</button>
         <button id="stashBtn" class="btn ghost">仓库</button>
         <button id="marketBtn" class="btn ghost">市场</button>
         <button id="settingsBtn" class="btn ghost">设置</button>
         <button id="logoutBtn" class="btn ghost">登出</button>
       </div>
     </div>

     <div class="lobby-right">
       <div class="panel-row">
         <div class="list" id="recentActivity">近期活动：<br>（占位）</div>
         <div class="list" id="serverInfo">游戏模式：本地模拟<br>版本：v0.1</div>
       </div>

       <div class="panel-row">
         <div class="list" id="friendsList">好友：<br>（占位）</div>
         <div class="list" id="shopPreview">仓库预览：<br>（占位）</div>
       </div>

       <div style="text-align:right; color:var(--muted); font-size:13px;">本地模式 — 账户数据仅保存在你的浏览器</div>
     </div>
   </div>
 </div>

 <!-- 仓库全屏（左侧格子 9x25） -->
 <div id="stashFull" style="display:none;">
   <div style="display:flex; gap:18px; height:100%; align-items:flex-start; justify-content:center;">
     <div style="width:760px; flex:0 0 760px; background:rgba(255,255,255,0.02); border-radius:12px; padding:18px; overflow:auto; display:flex; justify-content:center;">
       <div style="width:100%; max-width:100%;">
         <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:0 8px;">
           <div style="font-weight:900; font-size:20px; color:var(--neon1);">仓库（格子：9 × 25）</div>
           <div style="color:var(--muted); font-size:13px;">物品可占用多格（2×2 等） — 开局为空</div>
         </div>
         <div id="stashGridWrap" style="border-radius:8px; padding:8px; background:rgba(0,0,0,0.06); display:flex; justify-content:center;"></div>
       </div>
     </div>

     <div style="width:180px; display:flex; flex-direction:column; gap:12px; align-items:center;">
       <div style="width:100%; display:flex; justify-content:flex-end;">
         <button id="stashBackBtn" class="btn ghost" style="padding:8px 12px;">返回大厅</button>
       </div>
       <div style="width:100%; display:flex; flex-direction:column; gap:8px; align-items:center;">
         <div style="font-weight:800; color:var(--muted);">扩容箱</div>
         <div id="expansionList" style="display:flex; flex-direction:column; gap:8px; width:100%; align-items:center;">
           <div style="width:72px; height:72px; border-radius:8px; background:#e6e6e6; color:#111; display:flex; align-items:center; justify-content:center; font-weight:900;">A</div>
         </div>
       </div>
       <div style="margin-top:auto; width:100%; text-align:center;">
         <div style="font-size:12px; color:var(--muted);">提示：使用鼠标滚轮或触控拖动来查看下方格子。</div>
       </div>
     </div>
   </div>
 </div>

 <!-- 市场全屏 -->
 <div id="marketFull">
   <div style="display:flex; gap:18px; height:100%; align-items:flex-start; justify-content:center;">
     <div style="width:260px; flex:0 0 260px; background:rgba(255,255,255,0.02); border-radius:12px; padding:16px;">
       <div style="font-weight:900; font-size:20px; color:var(--neon1); margin-bottom:12px;">市场</div>
       <div id="marketTabs" style="display:flex; flex-direction:column; gap:10px;">
         <button class="market-tab btn ghost" data-cat="collections">收藏品</button>
         <button class="market-tab btn ghost" data-cat="knives">刀具</button>
         <button class="market-tab btn ghost" data-cat="helmets">头盔</button>
         <button class="market-tab btn ghost" data-cat="armors">护甲</button>
         <button class="market-tab btn ghost" data-cat="books">天赋书</button>
         <button class="market-tab btn ghost" data-cat="tactics">战术道具</button>
         <button class="market-tab btn ghost" data-cat="roomcards">房卡</button>
         <button class="market-tab btn ghost" data-cat="meds">药品</button>
         <button class="market-tab btn ghost" data-cat="packs">背包</button>
         <button class="market-tab btn ghost" data-cat="rigs">胸挂</button>
       </div>
     </div>

     <div style="flex:1; background:rgba(255,255,255,0.02); border-radius:12px; padding:16px; display:flex; flex-direction:column;">
       <!-- 提示/注释：把你的光明甲 SVG 放到项目目录，例如：assets/guangming.svg -->
       <div id="marketContent" style="flex:1; color:var(--muted); font-size:14px; display:flex; align-items:flex-start; justify-content:flex-start; gap:12px; padding:8px;">
         <!-- JS 填充 -->
       </div>
       <div style="margin-top:12px; text-align:right;">
         <button id="marketBackBtn" class="btn ghost">返回大厅</button>
       </div>
     </div>
   </div>
 </div>

<script>
/* ----------------------
   本地账号系统    - localStorage key: hackz_accounts_v1
   ---------------------- */
const ACC_KEY = 'hackz_accounts_v1';

// DOM
const agreeBtn = document.getElementById('agreeBtn');
const readMore = document.getElementById('readMore');
const termsDetail = document.getElementById('termsDetail');
const accountModal = document.getElementById('accountModal');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const guestBtn = document.getElementById('guestBtn');
const regUser = document.getElementById('regUser');
const regPass = document.getElementById('regPass');
const regPass2 = document.getElementById('regPass2');
const regBtn = document.getElementById('regBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const lobby = document.getElementById('lobby');
const lobbyName = document.getElementById('lobbyName');
const lobbyAvatar = document.getElementById('lobbyAvatar');
const playBtn = document.getElementById('playBtn');
const stashBtn = document.getElementById('stashBtn');
const marketBtn = document.getElementById('marketBtn');
const settingsBtn = document.getElementById('settingsBtn');
const logoutBtn = document.getElementById('logoutBtn');
const stashFull = document.getElementById('stashFull');
const stashGridWrap = document.getElementById('stashGridWrap');
const stashBackBtn = document.getElementById('stashBackBtn');
const marketFull = document.getElementById('marketFull');
const marketContent = document.getElementById('marketContent');
const marketBackBtn = document.getElementById('marketBackBtn');

let currentUser = null;
let playerSilver = 0; // 用“银币”表示玩家资金（显示为 K 单位）

// helper: load/save accounts
function loadAccounts(){
  try{
    const raw = localStorage.getItem(ACC_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){
    console.error(e);
    return {};
  }
}
function saveAccounts(obj){
  localStorage.setItem(ACC_KEY, JSON.stringify(obj));
}

// buffer->hex helper (used by SubtleCrypto path)
function buf2hex(buffer){
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00'+x.toString(16)).slice(-2)).join('');
}

// hash password via SubtleCrypto (with safe fallback for file:// or browsers lacking SubtleCrypto)
async function hashPassword(password){
  try{
    if(window.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function'){
      const enc = new TextEncoder();
      const data = enc.encode(password);
      const hashBuf = await crypto.subtle.digest('SHA-256', data);
      return buf2hex(hashBuf);
    } else {
      // fallback for insecure contexts (file://) — NOT cryptographically secure, but works for local demo
      console.warn('SubtleCrypto unavailable — using fallback hash (base64). For best results serve via http://localhost');
      return btoa(unescape(encodeURIComponent(password)));
    }
  }catch(err){
    console.error('hashPassword error:', err);
    return btoa(unescape(encodeURIComponent(password)));
  }
}

// 全局错误捕捉，防止未捕获错误导致其它绑定失效
window.addEventListener('error', function(e){
  console.error('Global error caught:', e.error || e.message);
  try{ showToast('脚本错误（查看控制台）: ' + (e.message || 'unknown')); }catch(_){}
});
window.addEventListener('unhandledrejection', function(e){
  console.error('Unhandled rejection:', e.reason);
  try{ showToast('脚本未处理的 promise 错误（查看控制台）'); }catch(_){}
});

// UI: show modal after agree
agreeBtn.addEventListener('click', ()=> {
  try{
    accountModal.style.display = 'flex';
    setTimeout(()=> regUser.focus(), 120);
  }catch(err){
    console.error('agreeBtn handler error:', err);
    showToast('发生错误（查看控制台）');
  }
});

// read more toggle
readMore.addEventListener('click', ()=> {
  try{
    if(termsDetail.style.display === 'none' || termsDetail.style.display === ''){ termsDetail.style.display = 'block'; readMore.innerText = '隐藏详细条款'; }
    else { termsDetail.style.display = 'none'; readMore.innerText = '查看详细条款'; }
  }catch(err){
    console.error('readMore handler error:', err);
  }
});

// register
regBtn.addEventListener('click', async ()=>{
  try{
    const u = (regUser.value||'').trim();
    const p1 = regPass.value||'';
    const p2 = regPass2.value||'';
    if(u.length < 3 || u.length > 20){ alert('用户名长度 3-20'); return; }
    if(!/^[\w\-]+$/.test(u)){ alert('用户名仅允许字母/数字/下划线/连字符'); return; }
    if(p1.length < 6){ alert('密码至少 6 字符'); return; }
    if(p1 !== p2){ alert('两次密码不一致'); return; }
    const accounts = loadAccounts();
    if(accounts[u]){ alert('用户名已存在（仅本设备）'); return; }
    const h = await hashPassword(p1);
    // 默认经济：1000k (1,000,000)
    accounts[u] = { username: u, pwHash: h, createdAt: Date.now(), saves: { economy: { data: { silver: 1000000 } } } };
    saveAccounts(accounts);
    currentUser = u;
    showToast(`已创建本地账号：${u}`);
    showLobbyFor(currentUser);
  }catch(e){
    console.error(e); alert('创建失败');
  }
});

// login
loginBtn.addEventListener('click', async ()=>{
  try{
    const u = (loginUser.value||'').trim();
    const p = loginPass.value||'';
    if(!u || !p){ alert('请输入用户名与密码'); return; }
    const accounts = loadAccounts();
    const acc = accounts[u];
    if(!acc){ alert('未找到本地账号'); return; }
    const h = await hashPassword(p);
    if(h !== acc.pwHash){ alert('密码错误'); return; }
    currentUser = u;
    showToast(`已登录：${u}`);
    showLobbyFor(currentUser);
  }catch(e){
    console.error(e); alert('登录失败');
  }
});

// guest
guestBtn.addEventListener('click', ()=>{
  try{
    const guest = 'guest_' + Math.floor(Math.random()*90000+10000);
    currentUser = guest;
    // 为游客创建临时账号并赋初始资金
    const accounts = loadAccounts();
    accounts[guest] = { username: guest, pwHash: null, createdAt: Date.now(), saves: { economy: { data: { silver: 1000000 } }, stash: { data: { grid: new Array(9*25).fill(null), bag: [] } } } };
    saveAccounts(accounts);
    showToast(`游客进入：${guest}`);
    showLobbyFor(currentUser);
  }catch(e){
    console.error(e);
  }
});

// export
exportBtn.addEventListener('click', ()=>{
  try{
    const all = loadAccounts();
    const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `midnight_raid_accounts_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showToast('已导出备份文件（请保存）');
  }catch(e){
    console.error(e); alert('导出失败');
  }
});

// import
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (ev)=>{
  try{
    const f = ev.target.files && ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
      try{
        const data = JSON.parse(e.target.result);
        if(typeof data !== 'object' || Array.isArray(data)){ alert('备份格式错误'); return; }
        const local = loadAccounts();
        if(!confirm('导入将合并/覆盖本地账号（同名账号会被覆盖）。确认继续？')) return;
        const merged = Object.assign({}, local, data);
        saveAccounts(merged);
        showToast('导入完成（已合并）');
      }catch(err){
        console.error(err); alert('读取备份失败');
      }
    };
    r.readAsText(f);
  }catch(err){
    console.error(err);
  }
});

// helpers
function hideModal(){ accountModal.style.display = 'none'; }
function showToast(txt){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = txt;
  Object.assign(el.style,{ position:'fixed', right:'18px', bottom:'18px', zIndex:80, background:'linear-gradient(90deg, rgba(72,240,255,0.12), rgba(138,91,255,0.08))', color:'#eaf6ff', padding:'10px 14px', borderRadius:'10px', fontWeight:800, boxShadow:'0 10px 40px rgba(10,12,20,0.6)', border:'1px solid rgba(255,255,255,0.03)' });
  document.body.appendChild(el);
  setTimeout(()=> { el.style.transition='opacity .6s'; el.style.opacity='0'; setTimeout(()=> el.remove(), 620); }, 2200);
}

/* ==============
   存取接口（游戏对接）
   ============== */
function loadSaveForUser(username){
  const accounts = loadAccounts();
  const acc = accounts[username];
  if(!acc) return null;
  return acc.saves || {};
}
function saveForUser(username, slotName, data){
  const accounts = loadAccounts();
  if(!accounts[username]) accounts[username] = { username, pwHash: null, createdAt: Date.now(), saves: {} };
  accounts[username].saves = accounts[username].saves || {};
  accounts[username].saves[slotName] = { data, updatedAt: Date.now() };
  saveAccounts(accounts);
}

/* ==============
   大厅显示与经济
   ============== */
function updateGoldDisplay(){
  const el = document.getElementById('goldDisplay');
  if(!el) return;
  const k = Math.floor((playerSilver || 0) / 1000);
  el.textContent = '银币: ' + k.toLocaleString() + 'K';
}
function showLobbyFor(username){
  try{
    document.querySelector('.wrap').style.display = 'none';
    accountModal.style.display = 'none';

    lobbyName.textContent = username;
    lobbyAvatar.textContent = username.slice(0,2).toUpperCase();

    const saves = loadSaveForUser(username) || {};
    const stash = saves && saves.stash ? (saves.stash.data || saves.stash) : { grid: new Array(9*25).fill(null), bag: [] };
    renderStashPreview(stash);

    const econ = saves && saves.economy ? (saves.economy.data || saves.economy) : null;
    playerSilver = (econ && typeof econ.silver === 'number') ? econ.silver : 1000000;
    updateGoldDisplay();

    lobby.style.display = 'flex';
  }catch(e){
    console.error(e);
  }
}
function renderStashPreview(stash){
  const preview = document.getElementById('shopPreview');
  if(!preview) return;
  let html = '';
  if(stash && stash.bag && stash.bag.length>0){
    html = stash.bag.slice(-6).reverse().map(i=>`<div style="font-size:13px;color:var(--muted)">${i}</div>`).join('');
  }else{
    html = '<div style="font-size:13px;color:var(--muted)">仓库为空</div>';
  }
  preview.innerHTML = html;
}

/* ==============
   仓库 UI 生成（9 x 25）
   ============== */
stashBtn.addEventListener('click', ()=>{
  try{
    if(!currentUser){ showToast('未登录'); return; }
    lobby.style.display = 'none';

    const saves = loadSaveForUser(currentUser) || {};
    let stash = saves && saves.stash ? (saves.stash.data || saves.stash) : null;
    const COLS = 9, ROWS = 25;
    if(!stash){
      stash = { grid: new Array(COLS*ROWS).fill(null), bag: [] };
      saveForUser(currentUser,'stash', stash);
    }

    const wrap = stashGridWrap;
    wrap.innerHTML = '';

    const SLOT_SIZE = 64;
    const GAP = 2;
    const totalGridWidth = COLS * SLOT_SIZE + (COLS - 1) * GAP + 16;
    wrap.style.width = totalGridWidth + 'px';
    wrap.style.overflowY = 'auto';
    wrap.style.maxHeight = 'calc(100vh - 140px)';
    wrap.style.display = 'flex';
    wrap.style.justifyContent = 'center';

    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = `repeat(${COLS}, ${SLOT_SIZE}px)`;
    grid.style.gridAutoRows = `${SLOT_SIZE}px`;
    grid.style.gap = GAP + 'px';
    grid.style.padding = '8px';

    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const idx = r*COLS + c;
        const slot = document.createElement('div');
        slot.className = 'stash-slot';
        slot.dataset.idx = idx;
        slot.style.width = SLOT_SIZE + 'px';
        slot.style.height = SLOT_SIZE + 'px';
        slot.style.border = '1px solid rgba(0,0,0,0.06)';
        slot.style.borderRadius = '4px';
        slot.style.background = '#e9e9e9';
        slot.style.display = 'flex';
        slot.style.alignItems = 'center';
        slot.style.justifyContent = 'center';
        slot.style.color = '#111';
        slot.style.fontSize = '12px';
        const val = stash.grid[idx];
        if(val){
          slot.textContent = val.name || 'Item';
          slot.style.background = 'rgba(72,240,255,0.12)';
          slot.style.border = '1px solid rgba(72,240,255,0.12)';
        }
        grid.appendChild(slot);
      }
    }

    wrap.appendChild(grid);
    stashFull.style.display = 'block';
  }catch(e){
    console.error(e);
    showToast('打开仓库失败（查看控制台）');
  }
});
stashBackBtn.addEventListener('click', ()=>{
  stashFull.style.display = 'none';
  lobby.style.display = 'flex';
});

/* ==============
   市场（armors）渲染：空卡片 + 价格 + 购买
   ============== */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function createMarketData(){
  const armors = [];
  armors.push({ id:'armor_red_1', name:'光明甲', rarity:'red', price: 274430 });
  for(let i=0;i<1;i++) armors.push({ id:`armor_red_${i+2}`, name:`红甲 ${i+2}`, rarity:'red', price: randInt(220000,300000) });
  for(let i=0;i<3;i++) armors.push({ id:`armor_lpur_${i+1}`, name:`亮紫甲 ${i+1}`, rarity:'brightPurple', price: randInt(50000,70000) });
  for(let i=0;i<5;i++) armors.push({ id:`armor_purp_${i+1}`, name:`紫甲 ${i+1}`, rarity:'purple', price: randInt(32000,38000) });
  for(let i=0;i<4;i++) armors.push({ id:`armor_blue_${i+1}`, name:`蓝甲 ${i+1}`, rarity:'blue', price: randInt(9000,16000) });
  return { armors };
}
const MARKET_DATA = createMarketData();

/* --- 为 光明甲 (armor_red_1) 生成加权随机价格 --- */
function generateGuangmingPrice(){
  const r = Math.random();
  if(r < 0.15) return randInt(589760, 671200);
  else if(r < 0.85) return randInt(671200, 791300);
  else return randInt(791300, 849990);
}

let marketPriceInterval = null;
const PRICE_REFRESH_MS = 6 * 60 * 1000;
function refreshGuangmingPriceAndMaybeRender(){ const item = MARKET_DATA.armors.find(x => x.id === 'armor_red_1'); if(item){ item.price = generateGuangmingPrice(); if(marketFull.style.display === 'block'){ renderArmorGrid(MARKET_DATA.armors); } } }
function startMarketPriceRefresh(){ refreshGuangmingPriceAndMaybeRender(); if(marketPriceInterval) clearInterval(marketPriceInterval); marketPriceInterval = setInterval(()=>{ refreshGuangmingPriceAndMaybeRender(); }, PRICE_REFRESH_MS); }
function stopMarketPriceRefresh(){ if(marketPriceInterval){ clearInterval(marketPriceInterval); marketPriceInterval = null; } }

function renderArmorGrid(list){
  try{
    marketContent.innerHTML = '';
    const grid = document.createElement('div');
    grid.style.display = 'grid';
    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(360px, 1fr))';
    grid.style.gap = '18px';
    grid.style.width = '100%';
    const colorMap = { green:'#6bbf59', blue:'#2e8ef7', purple:'#8a5bff', brightPurple:'#c77bff', red:'#ff6b6b' };

    list.forEach(item=>{
      const card = document.createElement('div');
      card.className = 'market-card';

      // visual: 200x200 正方形
      const vis = document.createElement('div');
      vis.className = 'market-visual';
      vis.style.background = colorMap[item.rarity] || '#ddd';
      vis.style.boxShadow = 'inset 0 0 0 2px rgba(0,0,0,0.06)';

      // 如果是光明甲（armor_red_1），放入 img 占位（使用正确的相对路径）
      if(item.id === 'armor_red_1'){
        const img = document.createElement('img');
        img.className = 'market-img';
        img.alt = '光明甲';

        // 正确的（也最常用）路径：相对于 index.html 的相对路径
        const primary = 'assets/guangming.svg';
        img.src = primary;
        // 失败时显示提示并尝试备用路径
        img.onerror = function(){
          console.warn('assets/guangming.svg 加载失败，尝试备用路径 /fastnight/assets/guangming.svg');
          // 备用尝试（当你以某些特殊方式部署时可能需要）
          const fallback = '/fastnight/assets/guangming.svg';
          img.onerror = function(){
            console.error('备用路径也失败：', fallback);
            showToast('图片加载失败：assets/guangming.svg（查看控制台）');
          };
          img.src = fallback;
        };

        vis.appendChild(img);
        vis.style.boxShadow = '0 14px 48px rgba(255,107,107,0.18), inset 0 0 0 2px rgba(0,0,0,0.06)';
      }

      // meta row: name & price
      const meta = document.createElement('div');
      meta.className = 'market-meta';
      const name = document.createElement('div');
      name.textContent = item.name; name.style.opacity = '0.95';
      const price = document.createElement('div');
      price.textContent = item.price.toLocaleString() + ' G';
      meta.appendChild(name); meta.appendChild(price);

      // actions: purchase button
      const actions = document.createElement('div');
      actions.className = 'market-actions';
      const buyBtn = document.createElement('button');
      buyBtn.className = 'btn';
      buyBtn.textContent = '购买';
      buyBtn.addEventListener('click', ()=>{
        try{
          if(!currentUser){ showToast('未登录'); return; }
          if(playerSilver < item.price){ showToast('银币不足'); return; }
          playerSilver -= item.price;
          saveForUser(currentUser,'economy',{ silver: playerSilver });
          updateGoldDisplay();
          const saves = loadSaveForUser(currentUser) || {};
          const stash = saves && saves.stash ? (saves.stash.data || saves.stash) : { grid:new Array(9*25).fill(null), bag:[] };
          stash.bag = stash.bag || [];
          stash.bag.push(item.name);
          saveForUser(currentUser,'stash', stash);
          showToast('购买成功并已放入仓库');
          renderStashPreview(stash);
          renderArmorGrid(MARKET_DATA.armors);
        }catch(e){
          console.error(e); showToast('购买失败');
        }
      });
      actions.appendChild(buyBtn);

      // assemble
      card.appendChild(vis);
      card.appendChild(meta);
      card.appendChild(actions);
      grid.appendChild(card);
    });

    marketContent.appendChild(grid);
  }catch(e){
    console.error(e);
    showToast('渲染市场失败（查看控制台）');
  }
}

/* ==============
   中键拖动支持（可保留），不影响鼠标滚轮滚动
   ============== */
let isMiddleDragging = false, middleDragStartY = 0, middleDragStartScroll = 0;
function onMiddleMouseDown(e){ if(e.button !== 1) return; e.preventDefault(); isMiddleDragging = true; middleDragStartY = e.clientY; middleDragStartScroll = marketContent.scrollTop; marketContent.classList.add('dragging'); document.addEventListener('mousemove', onMiddleMouseMove, { passive: false }); document.addEventListener('mouseup', onMiddleMouseUp, { once: true, passive: false }); }
function onMiddleMouseMove(e){ if(!isMiddleDragging) return; e.preventDefault(); const dy = e.clientY - middleDragStartY; marketContent.scrollTop = middleDragStartScroll - dy; }
function onMiddleMouseUp(e){ isMiddleDragging = false; marketContent.classList.remove('dragging'); document.removeEventListener('mousemove', onMiddleMouseMove); }
function attachMiddleDragSupport(){ marketContent.removeEventListener('mousedown', onMiddleMouseDown); marketContent.addEventListener('mousedown', onMiddleMouseDown, { passive: false }); marketContent.setAttribute('tabindex', '0'); }
function detachMiddleDragSupport(){ marketContent.removeEventListener('mousedown', onMiddleMouseDown); marketContent.removeAttribute('tabindex'); isMiddleDragging = false; marketContent.classList.remove('dragging'); }

// market open
marketBtn.addEventListener('click', ()=>{
  try{
    if(!currentUser){ showToast('未登录'); return; }
    lobby.style.display = 'none';
    marketFull.style.display = 'block';
    setTimeout(()=>{
      const tabs = document.querySelectorAll('.market-tab');
      const placeholder = document.createElement('div');
      placeholder.textContent = '当前分类暂无上架物品（AI 市场模拟）。';
      placeholder.style.color = 'var(--muted)';
      tabs.forEach(t=>{
        t.classList.remove('active');
        t.addEventListener('click', ()=>{
          tabs.forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
          const cat = t.dataset.cat;
          if(cat === 'armors'){
            renderArmorGrid(MARKET_DATA.armors);
          }else{
            marketContent.innerHTML = '';
            marketContent.appendChild(placeholder);
          }
        });
      });
      const armTab = document.querySelector('.market-tab[data-cat="armors"]');
      if(armTab) armTab.click();
      startMarketPriceRefresh();
      attachMiddleDragSupport();
      setTimeout(()=> marketContent.focus(), 120);
    },120);
  }catch(e){
    console.error(e);
    showToast('打开市场失败（查看控制台）');
  }
});
marketBackBtn.addEventListener('click', ()=>{
  marketFull.style.display = 'none';
  lobby.style.display = 'flex';
  stopMarketPriceRefresh();
  detachMiddleDragSupport();
});

/* utility: optional quick entry for dev */
// showLobbyFor('guest_12345'); // dev use

</script>
</body>
</html>



